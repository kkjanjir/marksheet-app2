<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
  <title>SBS Shiksha Niketan ‚Äì Marksheet System</title>
  <meta name="theme-color" content="#1a237e"/>
  <link rel="manifest" href="manifest.json"/>
  <link rel="apple-touch-icon" href="icon-192.png"/>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <style>
    :root{--primary:#1a237e;--accent:#c62828;--gold:#f9a825;--bg:#f0f2f5;}
    *{box-sizing:border-box;}
    body{font-family:'DM Sans',sans-serif;background:var(--bg);margin:0;padding:0;}
    .playfair{font-family:'Playfair Display',serif;}
    .glass-card{background:rgba(255,255,255,0.97);border-radius:16px;box-shadow:0 4px 24px rgba(0,0,0,0.08);}
    .inp{width:100%;padding:9px 13px;border:1.5px solid #e0e0e0;border-radius:9px;font-size:13px;font-family:'DM Sans',sans-serif;outline:none;transition:border 0.2s;background:#fafafa;}
    .inp:focus{border-color:var(--primary);background:#fff;}
    .marks-inp{width:100%;padding:5px 2px;border:1px solid #ddd;border-radius:5px;font-size:11px;text-align:center;outline:none;font-family:'DM Sans',sans-serif;}
    .marks-inp:focus{border-color:#1a237e;background:#e8eaf6;}
    .sync-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:5px;}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}
    .syncing{animation:pulse 1s infinite;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .fade-in{animation:fadeIn 0.25s ease;}
    .toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#323232;color:white;padding:11px 22px;border-radius:24px;font-size:13px;z-index:9999;font-family:'DM Sans',sans-serif;box-shadow:0 4px 20px rgba(0,0,0,0.3);white-space:nowrap;}
    ::-webkit-scrollbar{width:4px}::-webkit-scrollbar-thumb{background:#9fa8da;border-radius:10px;}
    .suggest-box{position:absolute;left:0;right:0;top:100%;background:white;border:1.5px solid #e0e0e0;border-radius:0 0 9px 9px;z-index:200;box-shadow:0 8px 24px rgba(0,0,0,0.1);max-height:180px;overflow-y:auto;}
    .suggest-item{padding:9px 13px;cursor:pointer;font-size:13px;border-bottom:1px solid #f0f0f0;transition:background 0.15s;}
    .suggest-item:hover{background:#e8eaf6;color:#1a237e;}

    /* ===== PRINT STYLES ===== */
    @media print {
      html, body { margin:0!important; padding:0!important; background:white!important; }
      body * { visibility:hidden!important; }
      #PRINT_AREA, #PRINT_AREA * { visibility:visible!important; }
      #PRINT_AREA {
        position:fixed!important;
        left:0!important; top:0!important; right:0!important; bottom:0!important;
        width:100%!important; height:100%!important;
        margin:0!important; padding:0!important;
        overflow:hidden!important;
        box-shadow:none!important;
        background:white!important;
        display:block!important;
      }
      @page{size:A4 portrait;margin:0;}
    }

    /* Desktop split layout */
    @media (min-width: 900px) {
      .app-shell { display:flex; height:100vh; overflow:hidden; }
      .editor-pane { width:420px; flex-shrink:0; overflow-y:auto; height:100vh; border-right:1px solid #e0e0e0; }
      .preview-pane { flex:1; overflow-y:auto; height:100vh; background:#555; display:flex; flex-direction:column; align-items:center; padding:20px; }
      .preview-pane-inner { transform-origin: top center; }
    }
    @media (max-width: 899px) {
      .app-shell { display:block; }
      .editor-pane { width:100%; }
      .preview-pane { display:none!important; }
    }
  </style>
</head>
<body>
<div id="root"></div>
<script>
const firebaseConfig={
  apiKey:"AIzaSyDw6lVRfXgehqpgvTCobqZZyLAy9alzAU8",
  authDomain:"sbs-marksheet.firebaseapp.com",
  projectId:"sbs-marksheet",
  storageBucket:"sbs-marksheet.firebasestorage.app",
  messagingSenderId:"1064566048496",
  appId:"1:1064566048496:web:0b7cf5d4b9fa0bf9dae435"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();
db.settings({cacheSizeBytes:firebase.firestore.CACHE_SIZE_UNLIMITED});
db.enablePersistence({synchronizeTabs:true}).catch(e=>console.log('Persistence:',e));
</script>
<script type="text/babel" data-presets="react">
const {useState,useEffect,useRef,useCallback,useMemo}=React;

/* ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ */
const SCHOOL_NAME="SBS SHIKSHA NIKETAN";
const SCHOOL_ADDR="Karaspur Prithvipur, Ghazipur, Uttar Pradesh ‚Äì 233226";
const SCHOOL_LOGO="logo.png"; // place logo.png in repo root

const DEFAULT_SUBJECTS=[
  "HINDI","ENGLISH","MATHEMATICS","SCIENCE","SOCIAL SCIENCE",
  "SANSKRIT","COMPUTER","ART AND DRAWING","G.K."
];
// Change #7: Sanskrit ‚Üí Art and Drawing (already reflected above, keeping Sanskrit too as per original + adding Art)
// Actually change #7 says replace Sanskrit with Art and Drawing:
const SUBJECTS_LIST=[
  "HINDI","ENGLISH","MATHEMATICS","SCIENCE","SOCIAL SCIENCE",
  "ART AND DRAWING","COMPUTER","G.K."
];

const GRADE_SCALE=[
  {min:91,max:100,grade:"A1",label:"OUTSTANDING"},
  {min:81,max:90,grade:"A2",label:"EXCELLENT"},
  {min:71,max:80,grade:"B1",label:"VERY GOOD"},
  {min:61,max:70,grade:"B2",label:"GOOD"},
  {min:51,max:60,grade:"C1",label:"AVERAGE"},
  {min:41,max:50,grade:"C2",label:"SATISFACTORY"},
  {min:33,max:40,grade:"D",label:"PASS"},
  {min:0,max:32,grade:"E",label:"FAIL"},
];
function getGrade(p){if(p===null||isNaN(p))return"-";for(const g of GRADE_SCALE)if(p>=g.min&&p<=g.max)return g.grade;return"-";}
function getGradeLabel(p){if(p===null||isNaN(p))return"-";for(const g of GRADE_SCALE)if(p>=g.min&&p<=g.max)return g.label;return"-";}

const REMARK_SUGGESTIONS=[
  "Excellent performance, keep it up!",
  "Good effort, needs improvement in weak subjects.",
  "Satisfactory performance, must work harder.",
  "Very good student, regular attendance required.",
  "Outstanding achievement, proud of the student.",
];
const ADDRESS_SUGGESTIONS=[
  "Nasiruddinpur, Prithvipur, Ghazipur, Uttar Pradesh 233226",
  "Prithvipur, Ghazipur, Uttar Pradesh 233226",
  "Karaspur, Prithvipur, Ghazipur, Uttar Pradesh 233226",
];

/* ‚îÄ‚îÄ CALC ‚îÄ‚îÄ */
function subTotal(s){return(parseFloat(s.obt1)||0)+(parseFloat(s.obt2)||0)+(parseFloat(s.obt3)||0);}
function subMM(s){return(parseFloat(s.mm1)||0)+(parseFloat(s.mm2)||0)+(parseFloat(s.mm3)||0);}
function grandTotals(subs){
  return subs.reduce((a,s)=>{
    a.mm1+=parseFloat(s.mm1)||0;a.obt1+=parseFloat(s.obt1)||0;
    a.mm2+=parseFloat(s.mm2)||0;a.obt2+=parseFloat(s.obt2)||0;
    a.mm3+=parseFloat(s.mm3)||0;a.obt3+=parseFloat(s.obt3)||0;
    a.mmG+=subMM(s);a.obtG+=subTotal(s);return a;
  },{mm1:0,obt1:0,mm2:0,obt2:0,mm3:0,obt3:0,mmG:0,obtG:0});
}
function pct(o,m){if(!m)return null;return parseFloat(((o/m)*100).toFixed(1));}

/* ‚îÄ‚îÄ FIREBASE ‚îÄ‚îÄ */
async function fbSave(student){
  await db.collection("students").doc(String(student.id)).set(student);
  const bRef=db.collection("backups").doc(String(student.id));
  const ex=await bRef.get();
  let v=ex.exists?(ex.data().versions||[]):[];
  v.unshift({...student,_at:new Date().toISOString()});
  if(v.length>2)v=v.slice(0,2);
  await bRef.set({versions:v});
}
async function fbLoadAll(){const s=await db.collection("students").get();return s.docs.map(d=>d.data());}
async function fbDelete(id){await db.collection("students").doc(String(id)).delete();}
async function fbBackups(id){const d=await db.collection("backups").doc(String(id)).get();return d.exists?d.data().versions||[]:[];}

/* ‚îÄ‚îÄ LOCAL STORAGE ‚îÄ‚îÄ */
const LS="sbs_v4";
function lsSave(d){try{localStorage.setItem(LS,JSON.stringify(d));}catch{}}
function lsLoad(){try{const r=localStorage.getItem(LS);return r?JSON.parse(r):[];}catch{return[];}}

/* ‚îÄ‚îÄ NEW STUDENT ‚îÄ‚îÄ */
function newStudent(){
  return{
    id:Date.now()+"_"+Math.floor(Math.random()*9999),
    name:"",father:"",mother:"",address:"",
    roll:"",admission:"",dob:"",cls:"",section:"",session:"2025-26",
    photo:null,
    attendance:{present:"",total:""},
    remarks:"",rank:"",
    subjects:SUBJECTS_LIST.map(n=>({name:n,mm1:60,obt1:"",mm2:60,obt2:"",mm3:60,obt3:""})),
    coScholastic:{sports:"",art:"",music:"",discipline:"",cleanliness:""},
    _createdAt:new Date().toISOString(),_updatedAt:new Date().toISOString(),
  };
}

/* ‚îÄ‚îÄ ICONS ‚îÄ‚îÄ */
const Ic={
  back:<svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2.5" viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>,
  add:<svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>,
  print:<svg width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>,
  trash:<svg width="15" height="15" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6M9 6V4h6v2"/></svg>,
  search:<svg width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
  upload:<svg width="15" height="15" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/></svg>,
  history:<svg width="15" height="15" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-4.95"/></svg>,
  cloud:<svg width="14" height="14" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>,
};

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
function Toast({msg}){return msg?<div className="toast">{msg}</div>:null;}

/* ‚îÄ‚îÄ SYNC BAR ‚îÄ‚îÄ */
function SyncBar({status,lastSync}){
  const c={synced:"#4caf50",syncing:"#ff9800",error:"#f44336",offline:"#9e9e9e",idle:"#bbb"};
  const l={synced:"Synced ‚úì",syncing:"Saving‚Ä¶",error:"Sync failed (local backup active)",offline:"Offline ‚Äì local backup active",idle:"Ready"};
  return(
    <div style={{background:"#f8f9ff",borderBottom:"1px solid #e8eaf6",padding:"4px 14px",display:"flex",alignItems:"center",fontSize:11,color:"#666",gap:6}}>
      <span style={{width:8,height:8,borderRadius:"50%",background:c[status]||"#bbb",display:"inline-block",animation:status==="syncing"?"pulse 1s infinite":""}}></span>
      <span>{Ic.cloud}</span>
      <span>{l[status]||"Ready"}</span>
      {lastSync&&status==="synced"&&<span style={{marginLeft:"auto",color:"#aaa"}}>{lastSync}</span>}
    </div>
  );
}

/* ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ */
function Dashboard({students,onNew,onSelect,syncStatus,lastSync}){
  const [search,setSearch]=useState("");
  const filtered=students.filter(s=>
    (s.name||"").toLowerCase().includes(search.toLowerCase())||
    (s.roll||"").includes(search)||(s.cls||"").toLowerCase().includes(search.toLowerCase())
  );
  const total=students.length;
  const passed=students.filter(s=>{const g=grandTotals(s.subjects);return g.mmG>0&&pct(g.obtG,g.mmG)>=33;}).length;
  const classes=[...new Set(students.map(s=>s.cls).filter(Boolean))].length;
  return(
    <div className="fade-in">
      <SyncBar status={syncStatus} lastSync={lastSync}/>
      <div style={{padding:14,paddingBottom:80}}>
        <div className="glass-card" style={{padding:18,marginBottom:14,textAlign:"center",background:"linear-gradient(135deg,#0d1b6e,#1a237e,#283593)"}}>
          <div style={{fontSize:10,letterSpacing:3,color:"rgba(255,255,255,0.65)",fontWeight:600,marginBottom:3}}>SCHOOL MANAGEMENT SYSTEM</div>
          <div className="playfair" style={{fontSize:20,fontWeight:800,color:"white",lineHeight:1.2}}>{SCHOOL_NAME}</div>
          <div style={{fontSize:10,color:"#90caf9",marginTop:2}}>{SCHOOL_ADDR}</div>
          <div style={{marginTop:12,display:"flex",justifyContent:"center",gap:12}}>
            {[["Students",total,"white"],["Passed",passed,"#a5d6a7"],["Classes",classes,"#ffcc80"]].map(([lbl,val,col])=>(
              <div key={lbl} style={{background:"rgba(255,255,255,0.12)",borderRadius:10,padding:"8px 16px",textAlign:"center"}}>
                <div style={{fontSize:22,fontWeight:800,color:col}}>{val}</div>
                <div style={{fontSize:10,color:"#90caf9"}}>{lbl}</div>
              </div>
            ))}
          </div>
        </div>
        <div style={{display:"flex",gap:10,marginBottom:14}}>
          <div style={{flex:1,position:"relative"}}>
            <span style={{position:"absolute",left:10,top:"50%",transform:"translateY(-50%)",color:"#aaa"}}>{Ic.search}</span>
            <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="Search name, class, roll‚Ä¶" className="inp" style={{paddingLeft:34}}/>
          </div>
          <button onClick={onNew} style={{background:"#1a237e",color:"white",border:"none",borderRadius:10,padding:"9px 16px",fontWeight:600,cursor:"pointer",fontFamily:"DM Sans",display:"flex",alignItems:"center",gap:6,whiteSpace:"nowrap",fontSize:13}}>
            {Ic.add} New
          </button>
        </div>
        {filtered.length===0?(
          <div className="glass-card" style={{padding:40,textAlign:"center"}}>
            <div style={{fontSize:44,marginBottom:8}}>üìã</div>
            <div style={{color:"#666",fontWeight:600}}>No students yet</div>
            <div style={{color:"#aaa",fontSize:12,marginTop:4}}>Tap "New" to add a student</div>
          </div>
        ):(
          <div style={{display:"flex",flexDirection:"column",gap:10}}>
            {filtered.map(s=>{
              const gt=grandTotals(s.subjects);
              const p=gt.mmG>0?pct(gt.obtG,gt.mmG):null;
              const pass=p!==null&&p>=33;
              return(
                <div key={s.id} onClick={()=>onSelect(s.id)} className="glass-card"
                  style={{padding:"12px 14px",display:"flex",alignItems:"center",gap:12,cursor:"pointer"}}>
                  <div style={{width:44,height:44,borderRadius:12,overflow:"hidden",background:"#e8eaf6",flexShrink:0,display:"flex",alignItems:"center",justifyContent:"center"}}>
                    {s.photo?<img src={s.photo} style={{width:"100%",height:"100%",objectFit:"cover"}}/>:<span style={{fontSize:20}}>üë§</span>}
                  </div>
                  <div style={{flex:1,minWidth:0}}>
                    <div style={{fontWeight:700,color:"#1a1a2e",fontSize:14,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{s.name||"Unnamed Student"}</div>
                    <div style={{fontSize:11,color:"#888",marginTop:2}}>
                      Class <b>{s.cls||"?"}{s.section?"-"+s.section:""}</b>
                      {s.roll&&<> ¬∑ Roll <b>{s.roll}</b></>}
                      {s.session&&<> ¬∑ {s.session}</>}
                    </div>
                  </div>
                  <div style={{textAlign:"right",flexShrink:0}}>
                    {p!==null&&<>
                      <div style={{fontWeight:800,fontSize:15,color:pass?"#2e7d32":"#c62828"}}>{p}%</div>
                      <span style={{background:pass?"#e8f5e9":"#ffebee",color:pass?"#2e7d32":"#c62828",padding:"1px 8px",borderRadius:20,fontSize:11,fontWeight:700}}>{getGrade(p)}</span>
                    </>}
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ ADDRESS AUTOCOMPLETE ‚îÄ‚îÄ */
function AddressInput({value,onChange}){
  const [show,setShow]=useState(false);
  const matches=ADDRESS_SUGGESTIONS.filter(a=>a.toLowerCase().includes((value||"").toLowerCase())&&value&&value.length>1);
  return(
    <div style={{position:"relative"}}>
      <input className="inp" placeholder="Address" value={value||""} onChange={e=>{onChange(e.target.value);setShow(true);}} onBlur={()=>setTimeout(()=>setShow(false),200)} style={{gridColumn:"span 2"}}/>
      {show&&matches.length>0&&(
        <div className="suggest-box">
          {matches.map((a,i)=><div key={i} className="suggest-item" onMouseDown={()=>{onChange(a);setShow(false);}}>{a}</div>)}
        </div>
      )}
    </div>
  );
}

/* ‚îÄ‚îÄ REMARK INPUT WITH SUGGESTIONS ‚îÄ‚îÄ */
function RemarkInput({value,onChange}){
  const [show,setShow]=useState(false);
  return(
    <div style={{position:"relative"}}>
      <textarea className="inp" rows="2" placeholder="Teacher's remarks‚Ä¶ (tap for suggestions)" value={value||""} 
        onChange={e=>onChange(e.target.value)} 
        onFocus={()=>setShow(true)} onBlur={()=>setTimeout(()=>setShow(false),200)}
        style={{resize:"none"}}/>
      {show&&(
        <div className="suggest-box">
          {REMARK_SUGGESTIONS.map((r,i)=>(
            <div key={i} className="suggest-item" onMouseDown={()=>{onChange(r);setShow(false);}}>{r}</div>
          ))}
          <div className="suggest-item" style={{color:"#888",fontStyle:"italic"}} onMouseDown={()=>setShow(false)}>‚úèÔ∏è Custom remark‚Ä¶</div>
        </div>
      )}
    </div>
  );
}

/* ‚îÄ‚îÄ DOB INPUT ‚Äî min 1999 ‚îÄ‚îÄ */
function DobInput({value,onChange}){
  return <input className="inp" type="date" value={value||""} onChange={e=>onChange(e.target.value)} min="1999-01-01" max={new Date().toISOString().split("T")[0]}/>;
}

/* ‚îÄ‚îÄ MARKS INPUT ‚Äî clamped 0..MM, no negative ‚îÄ‚îÄ */
function MarksInput({value,mm,onChange,style}){
  const handle=e=>{
    let v=e.target.value;
    if(v==="")return onChange("");
    let n=parseFloat(v);
    if(isNaN(n))return;
    if(n<0)n=0;
    const maxVal=parseFloat(mm)||60;
    if(n>maxVal)n=maxVal;
    onChange(String(n));
  };
  return <input className="marks-inp" type="number" min="0" max={mm||60} step="0.5" value={value} onChange={handle} style={style}/>;
}

/* ‚îÄ‚îÄ STUDENT EDITOR ‚îÄ‚îÄ */
function StudentEditor({student,onSave,onBack,onPreview,onDelete,toast}){
  const [s,setS]=useState(()=>JSON.parse(JSON.stringify(student)));
  const [backups,setBackups]=useState([]);
  const [showBk,setShowBk]=useState(false);
  const photoRef=useRef();
  const saveTimer=useRef();

  useEffect(()=>{
    clearTimeout(saveTimer.current);
    saveTimer.current=setTimeout(()=>onSave(s),1500);
    return()=>clearTimeout(saveTimer.current);
  },[s]);

  const upd=(f,v)=>setS(p=>({...p,[f]:v,_updatedAt:new Date().toISOString()}));
  const updSub=(i,f,v)=>{const subs=[...s.subjects];subs[i]={...subs[i],[f]:v};setS(p=>({...p,subjects:subs,_updatedAt:new Date().toISOString()}));};
  const addSub=()=>setS(p=>({...p,subjects:[...p.subjects,{name:"",mm1:60,obt1:"",mm2:60,obt2:"",mm3:60,obt3:""}]}));
  const removeSub=(i)=>setS(p=>({...p,subjects:p.subjects.filter((_,idx)=>idx!==i)}));

  const handlePhoto=e=>{
    const file=e.target.files[0];if(!file)return;
    if(file.size>500000){toast("‚ö†Ô∏è Photo too large! Use under 500KB");return;}
    const r=new FileReader();r.onload=ev=>setS(p=>({...p,photo:ev.target.result}));r.readAsDataURL(file);
  };
  const loadBk=async()=>{setBackups(await fbBackups(s.id));setShowBk(true);};

  const gt=grandTotals(s.subjects);
  const op=gt.mmG>0?pct(gt.obtG,gt.mmG):null;
  const pass=op!==null&&op>=33;

  return(
    <div className="fade-in" style={{paddingBottom:100}}>
      {/* Topbar */}
      <div style={{background:"linear-gradient(135deg,#1a237e,#283593)",padding:"12px 14px",display:"flex",alignItems:"center",gap:10,position:"sticky",top:0,zIndex:50}}>
        <button onClick={onBack} style={{background:"rgba(255,255,255,0.15)",border:"none",borderRadius:8,padding:"7px 11px",color:"white",cursor:"pointer",display:"flex",alignItems:"center"}}>{Ic.back}</button>
        <div style={{flex:1}}>
          <div style={{color:"white",fontWeight:700,fontSize:14,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{s.name||"New Student"}</div>
          <div style={{color:"#90caf9",fontSize:11}}>{s.cls?`Class ${s.cls}${s.section?"-"+s.section:""}`:""} {s.session}</div>
        </div>
        <button onClick={loadBk} style={{background:"rgba(255,255,255,0.12)",border:"none",borderRadius:8,padding:"7px 10px",color:"white",cursor:"pointer",display:"flex",alignItems:"center",gap:4,fontSize:11}} title="Backups">{Ic.history}</button>
        <button onClick={()=>{onSave(s);onPreview(s);}} style={{background:"#c62828",border:"none",borderRadius:8,padding:"8px 14px",color:"white",fontWeight:700,cursor:"pointer",fontFamily:"DM Sans",fontSize:12,display:"flex",alignItems:"center",gap:5}}>
          {Ic.print} Print
        </button>
      </div>

      <div style={{background:"#fffde7",borderBottom:"1px solid #fff9c4",padding:"4px 14px",fontSize:11,color:"#f57f17",display:"flex",alignItems:"center",gap:5}}>
        ‚ö° Auto-saving to Firebase‚Ä¶
      </div>

      <div style={{padding:14,display:"flex",flexDirection:"column",gap:14}}>
        {/* Score Banner */}
        {op!==null&&(
          <div style={{background:pass?"linear-gradient(135deg,#e8f5e9,#f1f8e9)":"linear-gradient(135deg,#ffebee,#fff3e0)",border:`1.5px solid ${pass?"#a5d6a7":"#ef9a9a"}`,borderRadius:14,padding:"12px 16px",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
            <div>
              <div style={{fontSize:11,color:"#666"}}>Overall Score</div>
              <div style={{fontSize:22,fontWeight:800,color:pass?"#2e7d32":"#c62828"}}>{gt.obtG} / {gt.mmG}</div>
            </div>
            <div style={{textAlign:"right"}}>
              <div style={{fontSize:28,fontWeight:900,color:pass?"#1b5e20":"#b71c1c"}}>{op}%</div>
              <div style={{background:pass?"#2e7d32":"#c62828",color:"white",padding:"2px 12px",borderRadius:20,fontSize:12,fontWeight:700,display:"inline-block"}}>{getGrade(op)} ‚Äì {getGradeLabel(op)}</div>
            </div>
          </div>
        )}

        {/* Backups */}
        {showBk&&(
          <div className="glass-card" style={{padding:14}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
              <b style={{fontSize:13}}>üìÇ Last 2 Backups</b>
              <button onClick={()=>setShowBk(false)} style={{background:"none",border:"none",cursor:"pointer",fontSize:18,color:"#888"}}>‚úï</button>
            </div>
            {backups.length===0?<div style={{color:"#aaa",fontSize:13}}>No backups yet</div>:
              backups.map((b,i)=>(
                <div key={i} style={{border:"1px solid #e0e0e0",borderRadius:10,padding:"10px 12px",marginBottom:8,display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                  <div>
                    <div style={{fontWeight:600,fontSize:13}}>{i===0?"üïê Latest":"üïë Previous"} Backup</div>
                    <div style={{fontSize:11,color:"#888"}}>{b._at?new Date(b._at).toLocaleString("en-IN"):""}</div>
                  </div>
                  <button onClick={()=>{setS(b);setShowBk(false);toast("‚úÖ Restored!");}} style={{background:"#1a237e",color:"white",border:"none",borderRadius:8,padding:"6px 12px",fontSize:12,fontWeight:600,cursor:"pointer"}}>Restore</button>
                </div>
              ))
            }
          </div>
        )}

        {/* Student Info */}
        <div className="glass-card" style={{padding:14}}>
          <div style={{fontWeight:700,color:"#333",marginBottom:12,fontSize:13}}>üë§ Student Information</div>
          <div style={{display:"flex",gap:12,marginBottom:12}}>
            <div onClick={()=>photoRef.current.click()} style={{width:80,height:96,border:"2px dashed #9fa8da",borderRadius:10,cursor:"pointer",overflow:"hidden",background:"#f5f5f5",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>
              {s.photo?<img src={s.photo} style={{width:"100%",height:"100%",objectFit:"cover"}}/>:<div style={{textAlign:"center",fontSize:11,color:"#aaa",padding:6}}>{Ic.upload}<br/>Photo<br/><span style={{fontSize:9}}>Max 500KB</span></div>}
            </div>
            <input ref={photoRef} type="file" accept="image/*" style={{display:"none"}} onChange={handlePhoto}/>
            <div style={{flex:1,display:"flex",flexDirection:"column",gap:8}}>
              <input className="inp" placeholder="Student Full Name *" value={s.name} onChange={e=>upd("name",e.target.value)}/>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
                <input className="inp" placeholder="Class (e.g. 5)" value={s.cls} onChange={e=>upd("cls",e.target.value)}/>
                <input className="inp" placeholder="Section (A/B)" value={s.section} onChange={e=>upd("section",e.target.value)}/>
              </div>
            </div>
          </div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
            <input className="inp" placeholder="Father's Name" value={s.father} onChange={e=>upd("father",e.target.value)}/>
            <input className="inp" placeholder="Mother's Name" value={s.mother} onChange={e=>upd("mother",e.target.value)}/>
            <input className="inp" placeholder="Roll No." value={s.roll} onChange={e=>upd("roll",e.target.value)}/>
            <input className="inp" placeholder="Admission No." value={s.admission} onChange={e=>upd("admission",e.target.value)}/>
            <DobInput value={s.dob} onChange={v=>upd("dob",v)}/>
            <input className="inp" placeholder="Session 2025-26" value={s.session} onChange={e=>upd("session",e.target.value)}/>
            <div style={{gridColumn:"span 2"}}>
              <AddressInput value={s.address} onChange={v=>upd("address",v)}/>
            </div>
          </div>
        </div>

        {/* Attendance */}
        <div className="glass-card" style={{padding:14}}>
          <div style={{fontWeight:700,color:"#333",marginBottom:10,fontSize:13}}>üìÖ Attendance</div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
            <div>
              <label style={{fontSize:11,color:"#888"}}>Days Present</label>
              <input className="inp" type="number" min="0" placeholder="e.g. 210" value={s.attendance.present} onChange={e=>setS(p=>({...p,attendance:{...p.attendance,present:e.target.value}}))}/>
            </div>
            <div>
              <label style={{fontSize:11,color:"#888"}}>Total Working Days</label>
              <input className="inp" type="number" min="0" placeholder="e.g. 240" value={s.attendance.total} onChange={e=>setS(p=>({...p,attendance:{...p.attendance,total:e.target.value}}))}/>
            </div>
          </div>
          {s.attendance.present&&s.attendance.total&&(
            <div style={{marginTop:6,fontSize:12,color:"#2e7d32",fontWeight:600}}>
              üìä {((s.attendance.present/s.attendance.total)*100).toFixed(0)}% Attendance
            </div>
          )}
        </div>

        {/* Marks */}
        <div className="glass-card" style={{padding:14}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}}>
            <div style={{fontWeight:700,color:"#333",fontSize:13}}>üìä Marks ‚Äì 3 Terms (MM: 60 each)</div>
            <button onClick={addSub} style={{background:"#e3f2fd",color:"#1565c0",border:"none",borderRadius:8,padding:"5px 12px",fontSize:12,fontWeight:600,cursor:"pointer"}}>+ Add</button>
          </div>
          <div style={{overflowX:"auto",WebkitOverflowScrolling:"touch"}}>
            <table style={{width:"100%",borderCollapse:"collapse",fontSize:11,minWidth:500}}>
              <thead>
                <tr style={{background:"#e8eaf6"}}>
                  <th style={{padding:"6px 4px",textAlign:"left",minWidth:85}}>Subject</th>
                  <th colSpan="2" style={{padding:"5px",color:"#1a237e",fontSize:10}}>Term 1</th>
                  <th colSpan="2" style={{padding:"5px",color:"#1a237e",fontSize:10}}>Term 2</th>
                  <th colSpan="2" style={{padding:"5px",color:"#1a237e",fontSize:10}}>Term 3</th>
                  <th style={{padding:"5px",color:"#c62828",fontSize:10}}>Total</th>
                  <th style={{padding:"5px",color:"#2e7d32",fontSize:10}}>%</th>
                  <th style={{padding:"5px",color:"#6a1b9a",fontSize:10}}>Grade</th>
                  <th style={{width:24}}></th>
                </tr>
                <tr style={{background:"#f3f4ff",fontSize:10}}>
                  <th></th>
                  <th style={{padding:"3px",color:"#888",fontWeight:500}}>MM</th><th style={{padding:"3px",color:"#444"}}>Obt</th>
                  <th style={{padding:"3px",color:"#888",fontWeight:500}}>MM</th><th style={{padding:"3px",color:"#444"}}>Obt</th>
                  <th style={{padding:"3px",color:"#888",fontWeight:500}}>MM</th><th style={{padding:"3px",color:"#444"}}>Obt</th>
                  <th></th><th></th><th></th><th></th>
                </tr>
              </thead>
              <tbody>
                {s.subjects.map((sub,i)=>{
                  const tot=subTotal(sub),mm=subMM(sub);
                  const p=mm>0?pct(tot,mm):null;
                  const pass=p!==null&&p>=33;
                  return(
                    <tr key={i} style={{borderBottom:"1px solid #eee",background:i%2===0?"#fafafa":"white"}}>
                      <td style={{padding:"3px"}}><input className="marks-inp" style={{textAlign:"left",fontWeight:600}} value={sub.name} onChange={e=>updSub(i,"name",e.target.value)} placeholder="Subject"/></td>
                      <td style={{padding:"2px"}}><input className="marks-inp" style={{width:34,background:"#e3f2fd"}} value={sub.mm1} onChange={e=>updSub(i,"mm1",e.target.value)}/></td>
                      <td style={{padding:"2px"}}><MarksInput value={sub.obt1} mm={sub.mm1} onChange={v=>updSub(i,"obt1",v)} style={{width:34}}/></td>
                      <td style={{padding:"2px"}}><input className="marks-inp" style={{width:34,background:"#e3f2fd"}} value={sub.mm2} onChange={e=>updSub(i,"mm2",e.target.value)}/></td>
                      <td style={{padding:"2px"}}><MarksInput value={sub.obt2} mm={sub.mm2} onChange={v=>updSub(i,"obt2",v)} style={{width:34}}/></td>
                      <td style={{padding:"2px"}}><input className="marks-inp" style={{width:34,background:"#e3f2fd"}} value={sub.mm3} onChange={e=>updSub(i,"mm3",e.target.value)}/></td>
                      <td style={{padding:"2px"}}><MarksInput value={sub.obt3} mm={sub.mm3} onChange={v=>updSub(i,"obt3",v)} style={{width:34}}/></td>
                      <td style={{padding:"3px 5px",fontWeight:700,color:"#c62828",textAlign:"center"}}>{mm>0?tot:""}</td>
                      <td style={{padding:"3px 5px",textAlign:"center",fontWeight:600,color:pass?"#2e7d32":"#c62828"}}>{p!==null?p+"%":""}</td>
                      <td style={{padding:"3px 5px",textAlign:"center"}}>
                        {p!==null&&<span style={{background:pass?"#e8f5e9":"#ffebee",color:pass?"#2e7d32":"#c62828",padding:"1px 6px",borderRadius:10,fontSize:11,fontWeight:700}}>{getGrade(p)}</span>}
                      </td>
                      <td style={{padding:"2px"}}><button onClick={()=>removeSub(i)} style={{background:"none",border:"none",cursor:"pointer",color:"#e57373",padding:2}}>{Ic.trash}</button></td>
                    </tr>
                  );
                })}
                <tr style={{background:"#e8eaf6",fontWeight:800,fontSize:12}}>
                  <td style={{padding:"6px 4px"}}>TOTAL</td>
                  <td style={{textAlign:"center",color:"#666"}}>{gt.mm1}</td><td style={{textAlign:"center"}}>{gt.obt1||0}</td>
                  <td style={{textAlign:"center",color:"#666"}}>{gt.mm2}</td><td style={{textAlign:"center"}}>{gt.obt2||0}</td>
                  <td style={{textAlign:"center",color:"#666"}}>{gt.mm3}</td><td style={{textAlign:"center"}}>{gt.obt3||0}</td>
                  <td style={{textAlign:"center",color:"#c62828"}}>{gt.obtG}/{gt.mmG}</td>
                  <td style={{textAlign:"center",color:pass?"#2e7d32":"#c62828"}}>{op}%</td>
                  <td style={{textAlign:"center"}}><span style={{background:"#1a237e",color:"white",padding:"1px 7px",borderRadius:10,fontSize:11}}>{op!==null?getGrade(op):""}</span></td>
                  <td></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        {/* Co-Scholastic */}
        <div className="glass-card" style={{padding:14}}>
          <div style={{fontWeight:700,color:"#333",marginBottom:10,fontSize:13}}>üé® Co-Scholastic (A+/A/B+/B/C)</div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
            {[["sports","‚öΩ Sports"],["art","üé® Art & Craft"],["music","üéµ Music & Dance"],["discipline","üìê Discipline"],["cleanliness","‚ú® Cleanliness"]].map(([k,lbl])=>(
              <div key={k}>
                <label style={{fontSize:11,color:"#888"}}>{lbl}</label>
                <select className="inp" value={s.coScholastic[k]} onChange={e=>setS(p=>({...p,coScholastic:{...p.coScholastic,[k]:e.target.value}}))}>
                  <option value="">‚Äì Select ‚Äì</option>
                  {["A+","A","B+","B","C"].map(g=><option key={g} value={g}>{g}</option>)}
                </select>
              </div>
            ))}
          </div>
        </div>

        {/* Remarks & Rank */}
        <div className="glass-card" style={{padding:14}}>
          <div style={{fontWeight:700,color:"#333",marginBottom:10,fontSize:13}}>‚úèÔ∏è Result & Remarks</div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:8}}>
            <div>
              <label style={{fontSize:11,color:"#888"}}>Class Rank</label>
              <input className="inp" placeholder="e.g. 3" value={s.rank||""} onChange={e=>upd("rank",e.target.value)}/>
            </div>
            <div>
              <label style={{fontSize:11,color:"#888"}}>Attendance %</label>
              <input className="inp" readOnly value={s.attendance.present&&s.attendance.total?((s.attendance.present/s.attendance.total)*100).toFixed(0)+"%":""} style={{background:"#f5f5f5"}}/>
            </div>
          </div>
          <RemarkInput value={s.remarks} onChange={v=>upd("remarks",v)}/>
        </div>

        <button onClick={onDelete} style={{width:"100%",padding:12,background:"#fff5f5",color:"#c62828",border:"1.5px solid #ffcdd2",borderRadius:12,fontWeight:600,cursor:"pointer",fontFamily:"DM Sans",fontSize:13}}>
          üóëÔ∏è Delete This Student
        </button>
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ MARKSHEET PRINT VIEW ‚îÄ‚îÄ */
function MarksheetPrint({student:s,onClose}){
  const gt=grandTotals(s.subjects);
  const op=gt.mmG>0?pct(gt.obtG,gt.mmG):null;
  const attPct=s.attendance.present&&s.attendance.total
    ?((s.attendance.present/s.attendance.total)*100).toFixed(0)+"%"
    :(s.attendance.present?s.attendance.present+" days":"");

  // Exact subject count ‚Äî only fill remaining rows up to 8 min, no extra padding
  const minRows=8;
  const padCount=Math.max(0,minRows-s.subjects.length);

  return(
    <div className="fade-in">
      {/* Controls */}
      <div style={{background:"#1a237e",padding:"12px 14px",display:"flex",alignItems:"center",gap:10,position:"sticky",top:0,zIndex:50}} className="no-print">
        <button onClick={onClose} style={{background:"rgba(255,255,255,0.15)",border:"none",borderRadius:8,padding:"7px 12px",color:"white",cursor:"pointer",display:"flex",alignItems:"center",gap:5,fontFamily:"DM Sans"}}>{Ic.back} Back</button>
        <div style={{flex:1,color:"white",fontWeight:600,fontSize:13,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{s.name} ‚Äì Marksheet</div>
        <button onClick={()=>window.print()} style={{background:"#c62828",border:"none",borderRadius:8,padding:"8px 16px",color:"white",fontWeight:700,cursor:"pointer",fontFamily:"DM Sans",display:"flex",alignItems:"center",gap:6,fontSize:13}}>
          {Ic.print} Print / PDF
        </button>
      </div>
      <div style={{background:"#fff8e1",padding:"7px 14px",fontSize:12,color:"#e65100",textAlign:"center"}} className="no-print">
        üí° Chrome mein print karo ‚Üí "Save as PDF" select karo for best results
      </div>

      {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê A4 MARKSHEET ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
      <div id="PRINT_AREA" style={{
        width:"210mm",height:"297mm",background:"white",
        margin:"0 auto",padding:0,
        boxSizing:"border-box",fontFamily:"Arial,sans-serif",
        overflow:"hidden",display:"flex",flexDirection:"column"
      }}>
        {/* Red outer border ‚Äî full bleed */}
        <div style={{border:"4px solid #c62828",margin:"4mm",flex:1,display:"flex",flexDirection:"column",overflow:"hidden"}}>
          <div style={{border:"1px solid #000",margin:"2px",flex:1,display:"flex",flexDirection:"column",padding:"4px 6px",overflow:"hidden"}}>

            {/* HEADER */}
            <div style={{display:"flex",alignItems:"flex-start",marginBottom:4,gap:6}}>
              {/* Logo */}
              <div style={{width:80,height:80,flexShrink:0,border:"1px solid #ccc",overflow:"hidden",display:"flex",alignItems:"center",justifyContent:"center",marginTop:4}}>
                <img src={SCHOOL_LOGO} style={{width:"100%",height:"100%",objectFit:"contain"}} onError={e=>{e.target.style.display="none";e.target.parentNode.innerHTML='<span style="font-size:9px;color:#aaa;text-align:center;padding:4px">SCHOOL<br/>LOGO</span>';}}/>
              </div>

              {/* Centre */}
              <div style={{flex:1,textAlign:"center",padding:"0 6px"}}>
                <div style={{fontSize:24,fontWeight:900,color:"#c62828",fontFamily:'"Times New Roman",serif',textTransform:"uppercase",letterSpacing:1,lineHeight:1.1}}>
                  {SCHOOL_NAME}
                </div>
                <div style={{fontSize:10,fontWeight:700,color:"#222",marginTop:2}}>{SCHOOL_ADDR}</div>
                <div style={{display:"inline-block",background:"#ffff00",color:"#c62828",padding:"3px 14px",fontWeight:900,fontSize:12,borderBottom:"2px solid #c62828",textDecoration:"underline",marginTop:5,marginBottom:3}}>
                  PROGRESS EVALUATION REPORT
                </div>
                {/* Change #2: Academic Session then Class below it */}
                <div style={{fontSize:11,fontWeight:700,color:"#1a237e",marginTop:2}}>
                  ACADEMIC SESSION: <span style={{color:"#000"}}>{s.session}</span>
                </div>
                <div style={{fontSize:12,fontWeight:900,color:"#000",fontFamily:'"Times New Roman",serif',marginTop:1}}>
                  CLASS: {s.cls}{s.section?"-"+s.section:""}
                </div>
              </div>

              {/* Photo ‚Äî change #10: slightly inset from corner */}
              <div style={{width:76,height:90,border:"1.5px solid #000",flexShrink:0,overflow:"hidden",background:"#f5f5f5",display:"flex",alignItems:"center",justifyContent:"center",marginTop:6,marginRight:2}}>
                {s.photo?<img src={s.photo} style={{width:"100%",height:"100%",objectFit:"cover"}}/>:<span style={{fontSize:9,color:"#aaa",textAlign:"center"}}>Photo</span>}
              </div>
            </div>

            {/* STUDENT INFO BOX ‚Äî change #9: left-aligned labels */}
            <div style={{background:"#d1eeee",borderTop:"2px solid #000",borderBottom:"2px solid #000",padding:"5px 8px",marginBottom:4,fontFamily:'"Times New Roman",serif',fontSize:10,fontWeight:700}}>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"2px 12px"}}>
                {/* Left column */}
                <div style={{display:"flex",flexDirection:"column",gap:3}}>
                  <div style={{display:"flex"}}><span style={{width:110,flexShrink:0}}>STUDENT'S NAME</span><span>:</span><span style={{marginLeft:4,textTransform:"uppercase",flex:1}}>{s.name}</span></div>
                  <div style={{display:"flex"}}><span style={{width:110,flexShrink:0}}>MOTHER'S NAME</span><span>:</span><span style={{marginLeft:4,textTransform:"uppercase",flex:1}}>{s.mother}</span></div>
                  <div style={{display:"flex"}}><span style={{width:110,flexShrink:0}}>FATHER'S NAME</span><span>:</span><span style={{marginLeft:4,textTransform:"uppercase",flex:1}}>{s.father}</span></div>
                  <div style={{display:"flex"}}><span style={{width:110,flexShrink:0}}>ADDRESS</span><span>:</span><span style={{marginLeft:4,textTransform:"uppercase",flex:1}}>{s.address}</span></div>
                </div>
                {/* Right column ‚Äî change #9: left-aligned within right column */}
                <div style={{display:"flex",flexDirection:"column",gap:3,paddingLeft:8}}>
                  <div style={{display:"flex"}}><span style={{width:100,flexShrink:0}}>ROLL NO.</span><span>:</span><span style={{marginLeft:4,fontWeight:900}}>{s.roll}</span></div>
                  <div style={{display:"flex"}}><span style={{width:100,flexShrink:0}}>ADMISSION NO.</span><span>:</span><span style={{marginLeft:4,fontWeight:900}}>{s.admission}</span></div>
                  <div style={{display:"flex"}}><span style={{width:100,flexShrink:0}}>DATE OF BIRTH</span><span>:</span><span style={{marginLeft:4}}>{s.dob}</span></div>
                </div>
              </div>
            </div>

            {/* MARKS TABLE */}
            <table style={{width:"100%",borderCollapse:"collapse",fontSize:9.5,marginBottom:3,tableLayout:"fixed"}}>
              <colgroup>
                <col style={{width:"20%"}}/><col style={{width:"6%"}}/><col style={{width:"9%"}}/>
                <col style={{width:"6%"}}/><col style={{width:"9%"}}/>
                <col style={{width:"6%"}}/><col style={{width:"9%"}}/>
                <col style={{width:"6%"}}/><col style={{width:"10%"}}/><col style={{width:"7%"}}/>
              </colgroup>
              <thead>
                <tr style={{background:"#fce4d6",height:28}}>
                  <th rowSpan="2" style={{border:"1px solid #000",textAlign:"left",paddingLeft:4,fontWeight:800,fontSize:10}}>SUBJECTS</th>
                  <th colSpan="2" style={{border:"1px solid #000",color:"#1a237e",fontWeight:700,fontSize:9}}>FIRST TERM</th>
                  <th colSpan="2" style={{border:"1px solid #000",color:"#1a237e",fontWeight:700,fontSize:9}}>SECOND TERM</th>
                  <th colSpan="2" style={{border:"1px solid #000",color:"#1a237e",fontWeight:700,fontSize:9}}>THIRD TERM</th>
                  <th colSpan="2" style={{border:"1px solid #000",color:"#1a237e",fontWeight:700,fontSize:9}}>GRAND TOTAL</th>
                  <th rowSpan="2" style={{border:"1px solid #000",fontWeight:700,fontSize:9}}>GRADE</th>
                </tr>
                <tr style={{background:"#fce4d6",height:22}}>
                  {["MM","MARKS OBT","MM","MARKS OBT","MM","MARKS OBT","MM","TOTAL"].map((h,i)=>(
                    <th key={i} style={{border:"1px solid #000",color:i%2===0?"#0070c0":"#333",fontWeight:700,fontSize:8,padding:"1px"}}>{h}</th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {s.subjects.map((sub,i)=>{
                  const tot=subTotal(sub),mm=subMM(sub);
                  const p=mm>0?pct(tot,mm):null;
                  return(
                    <tr key={i} style={{height:24,background:i%2===0?"white":"#fafafa"}}>
                      <td style={{border:"1px solid #000",paddingLeft:4,fontWeight:700,textTransform:"uppercase",fontSize:9.5,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{sub.name}</td>
                      <td style={{border:"1px solid #000",textAlign:"center",color:"#0070c0",fontWeight:700}}>{sub.mm1}</td>
                      <td style={{border:"1px solid #000",textAlign:"center",fontWeight:600}}>{sub.obt1}</td>
                      <td style={{border:"1px solid #000",textAlign:"center",color:"#0070c0",fontWeight:700}}>{sub.mm2}</td>
                      <td style={{border:"1px solid #000",textAlign:"center",fontWeight:600}}>{sub.obt2}</td>
                      <td style={{border:"1px solid #000",textAlign:"center",color:"#0070c0",fontWeight:700}}>{sub.mm3}</td>
                      <td style={{border:"1px solid #000",textAlign:"center",fontWeight:600}}>{sub.obt3}</td>
                      <td style={{border:"1px solid #000",textAlign:"center",color:"#0070c0",fontWeight:700}}>{mm>0?mm:""}</td>
                      <td style={{border:"1px solid #000",textAlign:"center",fontWeight:800}}>{mm>0?tot:""}</td>
                      <td style={{border:"1px solid #000",textAlign:"center",fontWeight:900,fontSize:10,color:p!==null&&p<33?"#c62828":"#1a237e"}}>{p!==null?getGrade(p):""}</td>
                    </tr>
                  );
                })}
                {/* Change #3: only fill to minimum 8 rows, no extra blank rows */}
                {[...Array(padCount)].map((_,i)=>(
                  <tr key={"p"+i} style={{height:24}}>{[...Array(10)].map((_,j)=><td key={j} style={{border:"1px solid #000"}}></td>)}</tr>
                ))}
                {/* Total */}
                <tr style={{background:"#f2f2f2",fontWeight:800,height:26,fontSize:9.5}}>
                  <td style={{border:"1px solid #000",paddingLeft:4}}>TOTAL</td>
                  <td style={{border:"1px solid #000",textAlign:"center",color:"#0070c0"}}>{gt.mm1}</td>
                  <td style={{border:"1px solid #000",textAlign:"center"}}>{gt.obt1||0}</td>
                  <td style={{border:"1px solid #000",textAlign:"center",color:"#0070c0"}}>{gt.mm2}</td>
                  <td style={{border:"1px solid #000",textAlign:"center"}}>{gt.obt2||0}</td>
                  <td style={{border:"1px solid #000",textAlign:"center",color:"#0070c0"}}>{gt.mm3}</td>
                  <td style={{border:"1px solid #000",textAlign:"center"}}>{gt.obt3||0}</td>
                  <td style={{border:"1px solid #000",textAlign:"center",color:"#0070c0"}}>{gt.mmG}</td>
                  <td style={{border:"1px solid #000",textAlign:"center"}}>{gt.obtG}</td>
                  <td style={{border:"1px solid #000"}}></td>
                </tr>
                {/* Percentage */}
                <tr style={{background:"#f2f2f2",fontWeight:800,height:26,fontSize:9.5}}>
                  <td style={{border:"1px solid #000",paddingLeft:4}}>PERCENTAGE</td>
                  <td colSpan="2" style={{border:"1px solid #000",textAlign:"center"}}>{gt.mm1>0?((gt.obt1/gt.mm1)*100).toFixed(0)+"%":""}</td>
                  <td colSpan="2" style={{border:"1px solid #000",textAlign:"center"}}>{gt.mm2>0?((gt.obt2/gt.mm2)*100).toFixed(0)+"%":""}</td>
                  <td colSpan="2" style={{border:"1px solid #000",textAlign:"center"}}>{gt.mm3>0?((gt.obt3/gt.mm3)*100).toFixed(0)+"%":""}</td>
                  <td colSpan="2" style={{border:"1px solid #000",textAlign:"center",fontSize:12,fontWeight:900}}>{op}%</td>
                  <td style={{border:"1px solid #000",textAlign:"center",fontWeight:900,fontSize:11,color:"#1a237e"}}>{getGrade(op)}</td>
                </tr>
              </tbody>
            </table>

            {/* CO-SCHOLASTIC */}
            <div style={{background:"#fce4d6",fontWeight:700,fontSize:9,padding:"3px 5px",border:"1px solid #000",display:"flex",justifyContent:"space-between",marginBottom:3}}>
              <span>Co-Scholastic Area</span>
              <span>A+:OUTSTANDING &nbsp; A:EXCELLENT &nbsp; B+:VERY GOOD &nbsp; B:GOOD &nbsp; C:AVERAGE</span>
            </div>
            <table style={{width:"100%",borderCollapse:"collapse",fontSize:9,marginBottom:3}}>
              <tbody>
                <tr style={{height:22}}>
                  {[["Sports & Games","sports"],["Art & Craft","art"],["Music & Dance","music"],["Discipline","discipline"],["Cleanliness","cleanliness"]].map(([lbl,k])=>(
                    <React.Fragment key={k}>
                      <td style={{border:"1px solid #000",padding:"2px 4px",fontWeight:700,background:"#fafafa",fontSize:9}}>{lbl}</td>
                      <td style={{border:"1px solid #000",textAlign:"center",fontWeight:900,color:"#1a237e",width:"5%"}}>{s.coScholastic[k]||""}</td>
                    </React.Fragment>
                  ))}
                </tr>
              </tbody>
            </table>

            {/* GRADE SCALE */}
            <div style={{display:"flex",border:"1px solid #000",marginBottom:5,height:24,fontSize:8.5}}>
              <div style={{background:"#595959",color:"white",fontWeight:700,width:"13%",display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center",padding:"0 3px",lineHeight:1.2,fontSize:8}}>MARK RANGE: GRADE</div>
              <div style={{flex:1,display:"flex"}}>
                {GRADE_SCALE.map((g,i)=>(
                  <div key={i} style={{flex:1,background:"#dbe5f1",borderLeft:"1px solid white",display:"flex",alignItems:"center",justifyContent:"center",fontWeight:600,fontSize:8}}>
                    {g.min===0?"00":g.min}-{g.max}:{g.grade}
                  </div>
                ))}
              </div>
            </div>

            {/* Change #5: Remark / Rank / Attendance ‚Äî better spaced 3-column layout */}
            {/* Change #6: Result:PASS removed */}
            <div style={{display:"grid",gridTemplateColumns:"1fr auto 1fr",gap:8,alignItems:"end",marginBottom:6,padding:"0 2px",fontSize:10,fontWeight:700}}>
              <div style={{display:"flex",alignItems:"flex-end",gap:4}}>
                <span style={{whiteSpace:"nowrap"}}>Remark:</span>
                <span style={{borderBottom:"1px solid #000",flex:1,minWidth:60,paddingBottom:1,fontSize:10}}>{s.remarks}</span>
              </div>
              <div style={{display:"flex",alignItems:"flex-end",gap:4,justifyContent:"center"}}>
                <span>Rank:</span>
                <span style={{borderBottom:"1px solid #000",minWidth:40,textAlign:"center",paddingBottom:1}}>{s.rank||""}</span>
              </div>
              <div style={{display:"flex",alignItems:"flex-end",gap:4,justifyContent:"flex-end"}}>
                <span style={{whiteSpace:"nowrap"}}>Attendance:</span>
                <span style={{borderBottom:"1px solid #000",minWidth:50,paddingBottom:1}}>{attPct}</span>
              </div>
            </div>

            {/* SIGNATURES ‚Äî pushed to bottom */}
            <div style={{marginTop:"auto",paddingTop:8,display:"flex",justifyContent:"space-between",fontSize:10,fontWeight:700,padding:"8px 16px 2px"}}>
              {["Date","Class Teacher","Principal"].map(lbl=>(
                <div key={lbl} style={{textAlign:"center"}}>
                  <div style={{borderTop:"2px dotted #000",width:110,marginBottom:3}}></div>
                  {lbl}
                </div>
              ))}
            </div>

          </div>
        </div>
      </div>
      {/* end PRINT_AREA */}
    </div>
  );
}

/* ‚îÄ‚îÄ DESKTOP PREVIEW PANE ‚îÄ‚îÄ */
function DesktopPreview({student}){
  if(!student) return(
    <div style={{color:"#ccc",textAlign:"center",marginTop:80,fontSize:14}}>
      <div style={{fontSize:48,marginBottom:12}}>üìÑ</div>
      Select a student to preview marksheet
    </div>
  );
  const gt=grandTotals(student.subjects);
  const op=gt.mmG>0?pct(gt.obtG,gt.mmG):null;
  const attPct=student.attendance.present&&student.attendance.total
    ?((student.attendance.present/student.attendance.total)*100).toFixed(0)+"%":"";
  const padCount=Math.max(0,8-student.subjects.length);

  return(
    <div style={{background:"white",width:"210mm",fontSize:"9px",fontFamily:"Arial,sans-serif",boxShadow:"0 8px 40px rgba(0,0,0,0.4)",transform:"scale(0.65)",transformOrigin:"top center",marginBottom:"-35%"}}>
      <div style={{border:"4px solid #c62828",margin:"4mm",display:"flex",flexDirection:"column"}}>
        <div style={{border:"1px solid #000",margin:2,padding:"4px 6px",display:"flex",flexDirection:"column"}}>
          {/* mini header */}
          <div style={{display:"flex",alignItems:"flex-start",gap:5,marginBottom:3}}>
            <div style={{width:60,height:60,border:"1px solid #ccc",display:"flex",alignItems:"center",justifyContent:"center",fontSize:7,color:"#aaa",flexShrink:0}}>LOGO</div>
            <div style={{flex:1,textAlign:"center"}}>
              <div style={{fontSize:16,fontWeight:900,color:"#c62828",fontFamily:"serif"}}>{SCHOOL_NAME}</div>
              <div style={{fontSize:7,fontWeight:700}}>{SCHOOL_ADDR}</div>
              <div style={{display:"inline-block",background:"#ffff00",color:"#c62828",padding:"1px 10px",fontWeight:900,fontSize:8,borderBottom:"1px solid #c62828",marginTop:2,marginBottom:2}}>PROGRESS EVALUATION REPORT</div>
              <div style={{fontSize:8,fontWeight:700,color:"#1a237e"}}>ACADEMIC SESSION: <span style={{color:"#000"}}>{student.session}</span></div>
              <div style={{fontSize:9,fontWeight:900}}>CLASS: {student.cls}{student.section?"-"+student.section:""}</div>
            </div>
            <div style={{width:55,height:65,border:"1.5px solid #000",overflow:"hidden",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,marginTop:4}}>
              {student.photo?<img src={student.photo} style={{width:"100%",height:"100%",objectFit:"cover"}}/>:<span style={{fontSize:7,color:"#aaa"}}>Photo</span>}
            </div>
          </div>
          {/* student info */}
          <div style={{background:"#d1eeee",borderTop:"1px solid #000",borderBottom:"1px solid #000",padding:"3px 5px",marginBottom:3,fontSize:7,fontWeight:700,display:"grid",gridTemplateColumns:"1fr 1fr",gap:"0 8px"}}>
            <div style={{display:"flex",flexDirection:"column",gap:1}}>
              {[["STUDENT'S NAME",student.name],["MOTHER'S NAME",student.mother],["FATHER'S NAME",student.father],["ADDRESS",student.address]].map(([l,v])=>(
                <div key={l} style={{display:"flex"}}><span style={{width:80,flexShrink:0}}>{l}</span>:<span style={{marginLeft:2,textTransform:"uppercase"}}>{v}</span></div>
              ))}
            </div>
            <div style={{display:"flex",flexDirection:"column",gap:1,paddingLeft:4}}>
              {[["ROLL NO.",student.roll],["ADMISSION NO.",student.admission],["DATE OF BIRTH",student.dob]].map(([l,v])=>(
                <div key={l} style={{display:"flex"}}><span style={{width:80,flexShrink:0}}>{l}</span>:<span style={{marginLeft:2}}>{v}</span></div>
              ))}
            </div>
          </div>
          {/* marks table mini */}
          <table style={{width:"100%",borderCollapse:"collapse",fontSize:7,marginBottom:2}}>
            <thead>
              <tr style={{background:"#fce4d6",height:16}}>
                <th rowSpan="2" style={{border:"0.5px solid #000",textAlign:"left",paddingLeft:2,fontWeight:800,fontSize:7,width:"20%"}}>SUBJECTS</th>
                {["FIRST TERM","SECOND TERM","THIRD TERM","GRAND TOTAL"].map(h=><th key={h} colSpan="2" style={{border:"0.5px solid #000",color:"#1a237e",fontSize:7}}>{h}</th>)}
                <th rowSpan="2" style={{border:"0.5px solid #000",fontSize:7}}>GRD</th>
              </tr>
              <tr style={{background:"#fce4d6",height:12}}>
                {["MM","OBT","MM","OBT","MM","OBT","MM","TOT"].map((h,i)=><th key={i} style={{border:"0.5px solid #000",color:i%2===0?"#0070c0":"#333",fontSize:6}}>{h}</th>)}
              </tr>
            </thead>
            <tbody>
              {student.subjects.map((sub,i)=>{
                const tot=subTotal(sub),mm=subMM(sub);
                const p=mm>0?pct(tot,mm):null;
                return(
                  <tr key={i} style={{height:14,background:i%2===0?"white":"#fafafa"}}>
                    <td style={{border:"0.5px solid #000",paddingLeft:2,fontWeight:700,textTransform:"uppercase",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{sub.name}</td>
                    <td style={{border:"0.5px solid #000",textAlign:"center",color:"#0070c0"}}>{sub.mm1}</td><td style={{border:"0.5px solid #000",textAlign:"center"}}>{sub.obt1}</td>
                    <td style={{border:"0.5px solid #000",textAlign:"center",color:"#0070c0"}}>{sub.mm2}</td><td style={{border:"0.5px solid #000",textAlign:"center"}}>{sub.obt2}</td>
                    <td style={{border:"0.5px solid #000",textAlign:"center",color:"#0070c0"}}>{sub.mm3}</td><td style={{border:"0.5px solid #000",textAlign:"center"}}>{sub.obt3}</td>
                    <td style={{border:"0.5px solid #000",textAlign:"center",color:"#0070c0"}}>{mm>0?mm:""}</td><td style={{border:"0.5px solid #000",textAlign:"center",fontWeight:700}}>{mm>0?tot:""}</td>
                    <td style={{border:"0.5px solid #000",textAlign:"center",fontWeight:900,color:p!==null&&p<33?"#c62828":"#1a237e"}}>{p!==null?getGrade(p):""}</td>
                  </tr>
                );
              })}
              {[...Array(padCount)].map((_,i)=><tr key={"p"+i} style={{height:14}}>{[...Array(10)].map((_,j)=><td key={j} style={{border:"0.5px solid #000"}}></td>)}</tr>)}
              <tr style={{background:"#f2f2f2",fontWeight:800,height:16}}><td style={{border:"0.5px solid #000",paddingLeft:2}}>TOTAL</td><td style={{border:"0.5px solid #000",textAlign:"center",color:"#0070c0"}}>{gt.mm1}</td><td style={{border:"0.5px solid #000",textAlign:"center"}}>{gt.obt1||0}</td><td style={{border:"0.5px solid #000",textAlign:"center",color:"#0070c0"}}>{gt.mm2}</td><td style={{border:"0.5px solid #000",textAlign:"center"}}>{gt.obt2||0}</td><td style={{border:"0.5px solid #000",textAlign:"center",color:"#0070c0"}}>{gt.mm3}</td><td style={{border:"0.5px solid #000",textAlign:"center"}}>{gt.obt3||0}</td><td style={{border:"0.5px solid #000",textAlign:"center",color:"#0070c0"}}>{gt.mmG}</td><td style={{border:"0.5px solid #000",textAlign:"center"}}>{gt.obtG}</td><td style={{border:"0.5px solid #000"}}></td></tr>
              <tr style={{background:"#f2f2f2",fontWeight:800,height:16}}><td style={{border:"0.5px solid #000",paddingLeft:2}}>PERCENTAGE</td><td colSpan="2" style={{border:"0.5px solid #000",textAlign:"center"}}>{gt.mm1>0?((gt.obt1/gt.mm1)*100).toFixed(0)+"%":""}</td><td colSpan="2" style={{border:"0.5px solid #000",textAlign:"center"}}>{gt.mm2>0?((gt.obt2/gt.mm2)*100).toFixed(0)+"%":""}</td><td colSpan="2" style={{border:"0.5px solid #000",textAlign:"center"}}>{gt.mm3>0?((gt.obt3/gt.mm3)*100).toFixed(0)+"%":""}</td><td colSpan="2" style={{border:"0.5px solid #000",textAlign:"center",fontWeight:900}}>{op}%</td><td style={{border:"0.5px solid #000",textAlign:"center",color:"#1a237e",fontWeight:900}}>{getGrade(op)}</td></tr>
            </tbody>
          </table>
          {/* footer mini */}
          <div style={{display:"grid",gridTemplateColumns:"1fr auto 1fr",gap:6,fontSize:7,fontWeight:700,marginTop:3}}>
            <div style={{display:"flex",gap:2}}><span>Remark:</span><span style={{borderBottom:"0.5px solid #000",flex:1}}>{student.remarks}</span></div>
            <div style={{display:"flex",gap:2}}><span>Rank:</span><span style={{borderBottom:"0.5px solid #000",minWidth:25,textAlign:"center"}}>{student.rank||""}</span></div>
            <div style={{display:"flex",gap:2,justifyContent:"flex-end"}}><span>Attendance:</span><span style={{borderBottom:"0.5px solid #000",minWidth:30}}>{attPct}</span></div>
          </div>
          <div style={{display:"flex",justifyContent:"space-between",marginTop:6,fontSize:7,fontWeight:700,padding:"0 10px"}}>
            {["Date","Class Teacher","Principal"].map(l=><div key={l} style={{textAlign:"center"}}><div style={{borderTop:"1px dotted #000",width:70,marginBottom:2}}></div>{l}</div>)}
          </div>
        </div>
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ */
function App(){
  const [screen,setScreen]=useState("dashboard");
  const [students,setStudents]=useState([]);
  const [activeId,setActiveId]=useState(null);
  const [printStudent,setPrintStudent]=useState(null);
  const [toastMsg,setToastMsg]=useState("");
  const [syncStatus,setSyncStatus]=useState("idle");
  const [lastSync,setLastSync]=useState("");
  const [loaded,setLoaded]=useState(false);
  const [previewStudent,setPreviewStudent]=useState(null);

  const showToast=msg=>{setToastMsg(msg);setTimeout(()=>setToastMsg(""),2600);};

  useEffect(()=>{
    setSyncStatus("syncing");
    fbLoadAll().then(data=>{
      if(data.length>0)setStudents(data);
      else{const l=lsLoad();if(l.length>0)setStudents(l);}
      setSyncStatus("synced");setLastSync(new Date().toLocaleTimeString("en-IN"));setLoaded(true);
    }).catch(()=>{
      const l=lsLoad();setStudents(l);setSyncStatus("offline");setLoaded(true);
      showToast("üì¥ Offline ‚Äì loaded from device storage");
    });
  },[]);

  useEffect(()=>{if(loaded)lsSave(students);},[students,loaded]);

  const handleSave=async(updated)=>{
    const next=students.map(s=>s.id===updated.id?updated:s);
    setStudents(next);lsSave(next);
    setPreviewStudent(updated);
    setSyncStatus("syncing");
    try{await fbSave(updated);setSyncStatus("synced");setLastSync(new Date().toLocaleTimeString("en-IN"));}
    catch{setSyncStatus("error");showToast("‚ö†Ô∏è Saved locally ‚Äì sync failed");}
  };

  const handleNew=async()=>{
    const s=newStudent();
    setStudents(prev=>[...prev,s]);
    setActiveId(s.id);setPreviewStudent(s);setScreen("editor");
    try{await fbSave(s);}catch{}
  };

  const handleSelect=id=>{
    setActiveId(id);
    const s=students.find(x=>x.id===id);
    setPreviewStudent(s);
    setScreen("editor");
  };

  const handleDelete=async()=>{
    if(!window.confirm("Delete this student permanently?"))return;
    const next=students.filter(s=>s.id!==activeId);
    setStudents(next);lsSave(next);setPreviewStudent(null);
    try{await fbDelete(activeId);}catch{}
    setScreen("dashboard");showToast("üóëÔ∏è Student deleted");
  };

  const activeStudent=students.find(s=>s.id===activeId);

  if(!loaded)return(
    <div style={{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",gap:14,background:"#f0f2f5"}}>
      <div style={{fontSize:44}}>üè´</div>
      <div style={{fontWeight:700,color:"#1a237e",fontSize:18}}>SBS Shiksha Niketan</div>
      <div style={{color:"#888",fontSize:13,display:"flex",alignItems:"center",gap:8}}>
        <span style={{width:8,height:8,borderRadius:"50%",background:"#ff9800",display:"inline-block",animation:"pulse 1s infinite"}}></span>
        Loading from Firebase‚Ä¶
      </div>
    </div>
  );

  /* Desktop: split pane */
  const isDesktop=window.innerWidth>=900;

  return(
    <div className={isDesktop?"app-shell":""}>
      {/* Editor / Dashboard pane */}
      <div className={isDesktop?"editor-pane":""}>
        {screen==="dashboard"&&<Dashboard students={students} onNew={handleNew} onSelect={handleSelect} syncStatus={syncStatus} lastSync={lastSync}/>}
        {screen==="editor"&&activeStudent&&<StudentEditor student={activeStudent} onSave={handleSave} onBack={()=>{setScreen("dashboard");setPreviewStudent(null);}} onPreview={s=>{setPrintStudent(s);setScreen("print");}} onDelete={handleDelete} toast={showToast}/>}
        {screen==="print"&&printStudent&&<MarksheetPrint student={printStudent} onClose={()=>setScreen("editor")}/>}
      </div>

      {/* Desktop right preview pane */}
      {isDesktop&&screen!=="print"&&(
        <div className="preview-pane">
          <div style={{color:"white",fontSize:11,marginBottom:12,opacity:0.7,letterSpacing:1}}>LIVE MARKSHEET PREVIEW</div>
          <div className="preview-pane-inner">
            <DesktopPreview student={previewStudent||activeStudent}/>
          </div>
        </div>
      )}

      <Toast msg={toastMsg}/>
    </div>
  );
}

const root=ReactDOM.createRoot(document.getElementById("root"));
root.render(<App/>);
</script>

<script>
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('sw.js')
      .then(()=>console.log('‚úÖ SW Registered'))
      .catch(e=>console.log('SW Error:',e));
  });
}
</script>
</body>
</html>
